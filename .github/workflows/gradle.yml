# .github/workflows/main.yml

name: Java CI with Gradle

on:
  push:
    branches: [ "main" ] # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches: [ "main" ] # main ë¸Œëœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë¹Œë“œ ì‘ì—… ì‹¤í–‰
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬

    steps:
    - uses: actions/checkout@v4 # GitHub ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4 # JDK 17 ì„¤ì •
      with:
        java-version: '17'
        distribution: 'temurin' # Adoptium Temurin ë°°í¬íŒ ì‚¬ìš©

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Grant execute permission for gradlew
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: chmod +x gradlew # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

    - name: Build with Gradle Wrapper
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: ./gradlew build # Gradle Wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ

    # ë¹Œë“œëœ JAR íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-app # ì•„í‹°íŒ©íŠ¸ ì´ë¦„
        path: ./Back-end/build/libs/*.jar # ë¹Œë“œëœ JAR íŒŒì¼ì˜ ê²½ë¡œ
        retention-days: 1 # ì•„í‹°íŒ©íŠ¸ ë³´ì¡´ ê¸°ê°„ (ì„ íƒ ì‚¬í•­)

  deploy:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë°°í¬ ì‘ì—… ì‹¤í–‰
    needs: build # 'build' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ 'deploy' ì‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬

    steps:
      # 1. ë¹Œë“œ ì¡ì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸(JAR íŒŒì¼)ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app # ì—…ë¡œë“œí–ˆë˜ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ê³¼ ë™ì¼
          path: ./ # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬(./)ë¡œ ë‹¤ìš´ë¡œë“œ

      # 2. EC2ì— ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì¤€ë¹„í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Setup directory and permissions on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            sudo mkdir -p /home/ubuntu/app
            sudo chown -R ${{ secrets.EC2_USERNAME }}:${{ secrets.EC2_USERNAME }} /home/ubuntu/app

      # 3. GitHub Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ application.properties íŒŒì¼ ìƒì„±
      - name: Create application.properties on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # EC2 ì„œë²„ì— application.properties íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
            cat <<EOF > /home/ubuntu/app/application.properties
            spring.application.name=back-end

            # MySQL
            spring.datasource.url=jdbc:mysql://10.0.2.83/test_user_db?serverTimezone=Asia/Seoul&useUnicode=true&characterEncoding=UTF-8
            spring.datasource.username=root
            spring.datasource.password=1234
            spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

            # JPA
            spring.jpa.hibernate.ddl-auto=update
            spring.jpa.show-sql=true
            spring.jpa.properties.hibernate.format_sql=true
            spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
            spring.jpa.properties.hibernate.connection.characterEncoding=utf8mb4
            spring.jpa.properties.hibernate.connection.useUnicode=true

            # JWT
            jwt.secret=${{ secrets.JWT_SECRET_KEY }}

            # Google SMTP
            spring.mail.host=smtp.gmail.com
            spring.mail.port=587
            spring.mail.username=whitejungle22@gmail.com
            spring.mail.password=${{ secrets.MAIL_PASSWORD }}
            spring.mail.protocol=smtp
            spring.mail.properties.mail.smtp.auth=true
            spring.mail.properties.mail.smtp.starttls.enable=true
            spring.mail.properties.mail.smtp.starttls.required=true
            spring.mail.properties.mail.smtp.connectiontimeout=5000
            spring.mail.properties.mail.smtp.timeout=3000
            spring.mail.properties.mail.smtp.writetimeout=5000

            # Redis
            spring.data.redis.host=localhost
            spring.data.redis.port=6379

            # Cloudinary
            cloudinary.cloud-name=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            cloudinary.api-key=${{ secrets.CLOUDINARY_API_KEY }}
            cloudinary.api-secret=${{ secrets.CLOUDINARY_API_SECRET }}

            # Kakao OAuth
            kakao.restApiKey=${{ secrets.KAKAO_REST_API_KEY }}
            kakao.redirectUri=${{ secrets.KAKAO_REDIRECT_URL }}

            # TourAPI
            tour.api.key=${{ secrets.TOUR_API_KEY }}
            tour.api.base-url=http://apis.data.go.kr/B551011/KorService2

            # File Size Limit
            spring.servlet.multipart.max-file-size=10MB
            spring.servlet.multipart.max-request-size=10MB

            # OpenWeather API
            weather.api.key=${{ secrets.OPENWEATHER_API_KEY }}
            weather.api.url=/data/2.5/weather

            # OpenAPI
            openai.api.key=${{ secrets.OPENAI_API_KEY }}
            openai.api.url=https://api.openai.com/v1/chat/completions
            springdoc.swagger-ui.url=http://43.200.227.73:8080/v3/api-docs
            EOF

      # 4. SCPë¥¼ ì‚¬ìš©í•´ EC2 ì„œë²„ë¡œ JAR íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "*.jar" # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  .jar íŒŒì¼ì„ ì „ì†¡
          target: "/home/ubuntu/app" # EC2ì˜ ë°°í¬ ê²½ë¡œ

      # 5. SSHë¡œ EC2ì— ì ‘ì†í•´ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Deploy Spring Boot App on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Java 17 ì„¤ì¹˜
            echo "â˜•ï¸ Java 17ì„ ì„¤ì¹˜í•˜ê±°ë‚˜ í™•ì¸í•©ë‹ˆë‹¤..."
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk

            DEPLOY_PATH="/home/ubuntu/app"
            cd ${DEPLOY_PATH}

            echo "ğŸ”¥ ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤ (í¬íŠ¸ 8080)..."
            PID=$(sudo lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "   PID ${PID}ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              sudo kill -9 "$PID"
            else
              echo "   8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            fi

            echo "ğŸ”„ ìƒˆë¡œìš´ JAR íŒŒì¼ë¡œ êµì²´í•©ë‹ˆë‹¤."
            rm -f app.jar
            NEWEST_JAR=$(ls -t *.jar | head -n 1)
            if [ -z "$NEWEST_JAR" ]; then
              echo "âŒ ë°°í¬í•  JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
            mv "${NEWEST_JAR}" app.jar

            echo "ğŸš€ ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
            # application.propertiesê°€ ìˆìœ¼ë¯€ë¡œ ë³„ë„ í”„ë¡œíŒŒì¼ ì§€ì • ì—†ì´ ì‹¤í–‰
            nohup java -jar app.jar > app.log 2>&1 &

            # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
            echo "â±ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì„ 10ì´ˆê°„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤..."
            sleep 10
            
            echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
            ps -ef | grep app.jar | grep -v grep
            if [ $? -eq 0 ]; then
                echo "âœ… ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
                echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. EC2 ì„œë²„ì˜ ${DEPLOY_PATH}/app.log íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
                exit 1
            fi
