name: Java CI with Gradle

on:
  push:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë¹Œë“œ ìž‘ì—… ì‹¤í–‰
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬

    steps:
    - uses: actions/checkout@v4 # GitHub ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4 # JDK 17 ì„¤ì •
      with:
        java-version: '17'
        distribution: 'temurin' # Adoptium Temurin ë°°í¬íŒ ì‚¬ìš©

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # Gradle í™˜ê²½ ì„¤ì • (v3.1.0)

    - name: Grant execute permission for gradlew
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: chmod +x gradlew # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

    - name: Build with Gradle Wrapper
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: ./gradlew build # Gradle Wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ

    # ë””ë²„ê¹…ìš©ìœ¼ë¡œ ì¶”ê°€í–ˆë˜ JAR íŒŒì¼ ì°¾ê¸° ìŠ¤í…ì€ ì´ì œ í•„ìš” ì—†ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    # í•˜ì§€ë§Œ í™•ì‹¤í•œ ê²½ë¡œ í™•ì¸ì„ ìœ„í•´ ìž ì‹œ ë‚¨ê²¨ë‘˜ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
    - name: Find JAR file path after build (for debugging)
      run: find . -name "*.jar"

  deploy:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë°°í¬ ìž‘ì—… ì‹¤í–‰
    needs: build # 'build' ìž‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ 'deploy' ìž‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬ (SSH Actionì— í•„ìš”)

    steps:
      # --- ì—¬ê¸°! `actions/checkout@v4` ìŠ¤í…ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤! ---
      # 'build' ìž¡ì—ì„œ ì´ë¯¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•˜ê³  ë¹Œë“œí–ˆìœ¼ë¯€ë¡œ,
      # 'deploy' ìž¡ì—ì„œëŠ” ë‹¤ì‹œ ì²´í¬ì•„ì›ƒí•  í•„ìš” ì—†ì´ ê¸°ì¡´ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

      - name: Verify JAR file path in deploy job (for debugging)
        run: |
          echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "GitHub Workspace: $GITHUB_WORKSPACE"
          echo "ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ íŒŒì¼ ëª©ë¡ (ë””ë²„ê¹…ìš©):"
          ls -R "${GITHUB_WORKSPACE}" # ì „ì²´ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ì˜ íŒŒì¼ ëª©ë¡ì„ ìž¬ê·€ì ìœ¼ë¡œ ì¶œë ¥

          # ì´ì „ì— ë¹Œë“œëœ JAR íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ê¸° ìœ„í•´ ì¶”ê°€ì ì¸ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          # ì´ ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ í†µí•´ ì •í™•í•œ JAR íŒŒì¼ ê²½ë¡œë¥¼ íŒŒì•…í•˜ì„¸ìš”.
          find "${GITHUB_WORKSPACE}" -name "*.jar"

      - name: Deploy Spring Boot App to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3 # SSH ì ‘ì†ì„ ìœ„í•œ GitHub Actionì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê³µìš© IP ë˜ëŠ” DNSë¥¼ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          username: ${{ secrets.EC2_USERNAME }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•  ì‚¬ìš©ìž ì´ë¦„(ì˜ˆ: ubuntu, ec2-user)ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          key: ${{ secrets.EC2_SSH_KEY }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í”„ë¼ì´ë¹— í‚¤ ë‚´ìš©ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          port: 22 # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í¬íŠ¸ìž…ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ 22ìž…ë‹ˆë‹¤.
          script: |
            # 1. ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ðŸ”¥ ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤ (í¬íŠ¸ 8080)..."
            PID=$(sudo lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "   PID ${PID}ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              sudo kill -9 "$PID"
            else
              echo "   8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            fi

            # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ê¸°ì¡´ JAR íŒŒì¼ ì‚­ì œ
            DEPLOY_PATH="/home/ubuntu/app" # EC2 ë‚´ì˜ ë°°í¬ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë³€ê²½í•˜ì„¸ìš”.
            echo "âž¡ï¸ ë°°í¬ ê²½ë¡œ ${DEPLOY_PATH}ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            if [ ! -d "${DEPLOY_PATH}" ]; then
              echo "   ë°°í¬ ë””ë ‰í† ë¦¬ ${DEPLOY_PATH}ê°€ ì¡´ìž¬í•˜ì§€ ì•Šì•„ ìƒì„±í•©ë‹ˆë‹¤."
              sudo mkdir -p "${DEPLOY_PATH}"
            fi
            cd "${DEPLOY_PATH}"

            echo "ðŸ—‘ï¸ï¸ ê¸°ì¡´ 'app.jar' íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤."
            rm -f app.jar

            # 3. ìƒˆë¡œìš´ JAR íŒŒì¼ ë³µì‚¬
            # 'Travel_Back' ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ê³¼ í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ê°€ì •í•˜ì—¬ ì„¤ì •ëœ ê²½ë¡œìž…ë‹ˆë‹¤.
            # ì´ ê²½ë¡œëŠ” 'build' ìž¡ì—ì„œ ìƒì„±ëœ JAR íŒŒì¼ì˜ ê²½ë¡œë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
            # `actions/checkout@v4`ë¥¼ ì œê±°í–ˆìœ¼ë¯€ë¡œ, ì´ì œ JAR íŒŒì¼ì´ ë‚¨ì•„ìžˆì„ ê²ƒìž…ë‹ˆë‹¤.
            SOURCE_JAR="/home/runner/work/Travel_Back/Travel_Back/Back-end/build/libs/*.jar"
            
            JAR_FILE=$(ls -t ${SOURCE_JAR} 2>/dev/null | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ ë¹Œë“œëœ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${SOURCE_JAR}"
              exit 1 # JAR íŒŒì¼ì„ ì°¾ì§€ ëª»í•˜ë©´ ë°°í¬ ì‹¤íŒ¨
            fi

            echo "ðŸ“¥ ìƒˆë¡œìš´ JAR íŒŒì¼ '${JAR_FILE}'ì„ ${DEPLOY_PATH}ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤."
            cp "${JAR_FILE}" app.jar
            
            # 4. ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
            echo "ðŸš€ ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
            nohup java -jar app.jar > /dev/null 2>&1 < /dev/null &
            echo "âœ… ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤."
