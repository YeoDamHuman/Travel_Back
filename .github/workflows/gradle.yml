name: Java CI with Gradle

on:
  push:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë¹Œë“œ ìž‘ì—… ì‹¤í–‰
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬

    steps:
    - uses: actions/checkout@v4 # GitHub ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4 # JDK 17 ì„¤ì •
      with:
        java-version: '17'
        distribution: 'temurin' # Adoptium Temurin ë°°í¬íŒ ì‚¬ìš©

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # Gradle í™˜ê²½ ì„¤ì • (v3.1.0)

    - name: Grant execute permission for gradlew
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      # í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§žê²Œ './Back-end' ê²½ë¡œë¥¼ í™•ì¸/ìˆ˜ì •í•´ì£¼ì„¸ìš”.
      working-directory: ./Back-end
      run: chmod +x gradlew # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

    - name: Build with Gradle Wrapper
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      # í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§žê²Œ './Back-end' ê²½ë¡œë¥¼ í™•ì¸/ìˆ˜ì •í•´ì£¼ì„¸ìš”.
      working-directory: ./Back-end
      run: ./gradlew build # Gradle Wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ

    - name: Find JAR file path
      run: |
        # ë¹Œë“œëœ JAR íŒŒì¼ì˜ ì •í™•í•œ ê²½ë¡œë¥¼ ì°¾ì•„ ì¶œë ¥í•©ë‹ˆë‹¤.
        # ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë”°ë¼ Back-end/ ë˜ëŠ” ë‹¤ë¥¸ ê²½ë¡œë¥¼ ì ì ˆížˆ ìˆ˜ì •í•˜ì„¸ìš”.
        find . -name "*.jar"
        # ì´ ëª…ë ¹ì˜ ì¶œë ¥ ë¡œê·¸ì—ì„œ ì‹¤ì œ JAR íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”!

  deploy:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë°°í¬ ìž‘ì—… ì‹¤í–‰
    needs: build # 'build' ìž‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ 'deploy' ìž‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    # 'main' ë¸Œëžœì¹˜ì— 'push' ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œë§Œ ë°°í¬ ìž‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬ (SSH Actionì— í•„ìš”)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•´ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë‹¤ì‹œ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
        # GitHub Actionsì˜ ìž‘ì—… ê³µê°„ì—ì„œ ë¹Œë“œëœ ì•„í‹°íŒ©íŠ¸ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹ ,
        # ë‹¤ì‹œ ì²´í¬ì•„ì›ƒí•˜ì—¬ SSH ì „ì†¡ì„ ìœ„í•œ íŒŒì¼ ê²½ë¡œë¥¼ ì‰½ê²Œ í™•ë³´í•©ë‹ˆë‹¤.

      - name: Verify JAR file path in deploy job (for debugging)
        run: |
          echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "GitHub Workspace: $GITHUB_WORKSPACE"
          echo "ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ íŒŒì¼ ëª©ë¡ (ë””ë²„ê¹…ìš©):"
          ls -R "${GITHUB_WORKSPACE}" # ì „ì²´ ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ì˜ íŒŒì¼ ëª©ë¡ì„ ìž¬ê·€ì ìœ¼ë¡œ ì¶œë ¥

          # ì´ì „ì— ë¹Œë“œëœ JAR íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ê¸° ìœ„í•´ ì¶”ê°€ì ì¸ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          # ì´ ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ í†µí•´ ì •í™•í•œ JAR íŒŒì¼ ê²½ë¡œë¥¼ íŒŒì•…í•˜ì„¸ìš”.
          find "${GITHUB_WORKSPACE}" -name "*.jar"

      - name: Deploy Spring Boot App to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3 # SSH ì ‘ì†ì„ ìœ„í•œ GitHub Actionì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê³µìš© IP ë˜ëŠ” DNSë¥¼ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          username: ${{ secrets.EC2_USERNAME }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•  ì‚¬ìš©ìž ì´ë¦„(ì˜ˆ: ubuntu, ec2-user)ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          key: ${{ secrets.EC2_SSH_KEY }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í”„ë¼ì´ë¹— í‚¤ ë‚´ìš©ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          port: 22 # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í¬íŠ¸ìž…ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ 22ìž…ë‹ˆë‹¤.
          script: |
            # 1. ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            # ê¸°ë³¸ì ìœ¼ë¡œ Spring BootëŠ” 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸ë¡œ ë³€ê²½í•˜ì„¸ìš”.
            echo "ðŸ”¥ ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤ (í¬íŠ¸ 8080)..."
            # 8080 í¬íŠ¸ì˜ PIDë¥¼ ì°¾ê³ , PIDê°€ ì¡´ìž¬í•  ê²½ìš°ì—ë§Œ kill ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            PID=$(sudo lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "   PID ${PID}ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              sudo kill -9 "$PID"
            else
              echo "   8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            fi

            # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ê¸°ì¡´ JAR íŒŒì¼ ì‚­ì œ
            # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°°í¬ë  ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ë””ë ‰í† ë¦¬ëŠ” ë¯¸ë¦¬ ìƒì„±í•´ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            # ë§Œì•½ ë””ë ‰í† ë¦¬ê°€ ì—†ë‹¤ë©´ ìƒì„± í›„ ì´ë™í•©ë‹ˆë‹¤.
            DEPLOY_PATH="/home/ubuntu/app" # EC2 ë‚´ì˜ ë°°í¬ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë³€ê²½í•˜ì„¸ìš”.
            echo "âž¡ï¸ ë°°í¬ ê²½ë¡œ ${DEPLOY_PATH}ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            if [ ! -d "${DEPLOY_PATH}" ]; then
              echo "   ë°°í¬ ë””ë ‰í† ë¦¬ ${DEPLOY_PATH}ê°€ ì¡´ìž¬í•˜ì§€ ì•Šì•„ ìƒì„±í•©ë‹ˆë‹¤."
              sudo mkdir -p "${DEPLOY_PATH}"
            fi
            cd "${DEPLOY_PATH}"

            echo "ðŸ—‘ï¸ï¸ ê¸°ì¡´ 'app.jar' íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤."
            rm -f app.jar

            # 3. ìƒˆë¡œìš´ JAR íŒŒì¼ ë³µì‚¬
            # GitHub Actions ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆì˜ ìž‘ì—… ê³µê°„ì—ì„œ ë¹Œë“œëœ .jar íŒŒì¼ì„ EC2ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
            # 'Travel_Back' ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ê³¼ í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ ê°€ì •í•˜ì—¬ ì„¤ì •ëœ ê²½ë¡œìž…ë‹ˆë‹¤.
            # ì´ ê²½ë¡œê°€ ë§žëŠ”ì§€ `build` ìž¡ì˜ ë¡œê·¸ì—ì„œ í™•ì¸í•˜ê±°ë‚˜, ì•„ëž˜ ë””ë²„ê¹… ìŠ¤í…ì„ í™œìš©í•˜ì„¸ìš”.
            SOURCE_JAR="/home/runner/work/Travel_Back/Travel_Back/Back-end/build/libs/*.jar"
            
            # ì—¬ëŸ¬ ê°œì˜ .jar íŒŒì¼ì´ ìžˆì„ ê²½ìš° (ì¼ë°˜ì ì¸ ë¹Œë“œì—ì„œëŠ” ë“œë¬¼ì§€ë§Œ), ê°€ìž¥ ìµœê·¼ ê²ƒì„ ì„ íƒ
            JAR_FILE=$(ls -t ${SOURCE_JAR} 2>/dev/null | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ ë¹Œë“œëœ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${SOURCE_JAR}"
              exit 1 # JAR íŒŒì¼ì„ ì°¾ì§€ ëª»í•˜ë©´ ë°°í¬ ì‹¤íŒ¨
            fi

            echo "ðŸ“¥ ìƒˆë¡œìš´ JAR íŒŒì¼ '${JAR_FILE}'ì„ ${DEPLOY_PATH}ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤."
            cp "${JAR_FILE}" app.jar
            
            # 4. ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
            # 'nohup'ê³¼ '&'ë¥¼ ì‚¬ìš©í•˜ì—¬ SSH ì„¸ì…˜ì´ ëŠê²¨ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
            # í‘œì¤€ ì¶œë ¥/ì˜¤ë¥˜ë¥¼ /dev/nullë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ì—¬ ì„¸ì…˜ì— ë©”ì‹œì§€ê°€ ë‚¨ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
            # ë§Œì•½ ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ë‚¨ê¸°ê³  ì‹¶ë‹¤ë©´ '> ${DEPLOY_PATH}/app.log 2>&1' ë“±ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
            echo "ðŸš€ ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
            nohup java -jar app.jar > /dev/null 2>&1 < /dev/null &
            echo "âœ… ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤."
