name: Java CI with Gradle

on:
  push:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches: [ "main" ] # main ë¸Œëžœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë¹Œë“œ ìž‘ì—… ì‹¤í–‰
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬

    steps:
    - uses: actions/checkout@v4 # GitHub ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4 # JDK 17 ì„¤ì •
      with:
        java-version: '17'
        distribution: 'temurin' # Adoptium Temurin ë°°í¬íŒ ì‚¬ìš©

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # Gradle í™˜ê²½ ì„¤ì • (v3.1.0)

    - name: Grant execute permission for gradlew
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: chmod +x gradlew # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

    - name: Build with Gradle Wrapper
      # 'gradlew' íŒŒì¼ì´ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ë¡œ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
      working-directory: ./Back-end
      run: ./gradlew build # Gradle Wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ

    # ë¹Œë“œëœ JAR íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-app # ì•„í‹°íŒ©íŠ¸ ì´ë¦„
        path: ./Back-end/build/libs/*.jar # ë¹Œë“œëœ JAR íŒŒì¼ì˜ ê²½ë¡œ (ì´ì „ ë¡œê·¸ì—ì„œ í™•ì¸ë¨)
        retention-days: 1 # ì•„í‹°íŒ©íŠ¸ ë³´ì¡´ ê¸°ê°„ (ì„ íƒ ì‚¬í•­)

  deploy:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ë°°í¬ ìž‘ì—… ì‹¤í–‰
    needs: build # 'build' ìž‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ 'deploy' ìž‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ ë¶€ì—¬ (SSH Actionì— í•„ìš”)

    steps:
      # ë¹Œë“œ ìž¡ì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸(JAR íŒŒì¼)ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app # ì—…ë¡œë“œí–ˆë˜ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ê³¼ ë™ì¼
          path: ./ # í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬(./)ë¡œ ë‹¤ìš´ë¡œë“œ

      # ì´ì œëŠ” JAR íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆì„ ê²ƒì´ë¯€ë¡œ, ë””ë²„ê¹…ìš© íŒŒì¼ ëª©ë¡ ìŠ¤í…ì€ ì œê±°í•©ë‹ˆë‹¤.
      # - name: Verify JAR file path in deploy job (for debugging)
      #   run: |
      #     echo "í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
      #     echo "GitHub Workspace: $GITHUB_WORKSPACE"
      #     echo "ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì˜ íŒŒì¼ ëª©ë¡ (ë””ë²„ê¹…ìš©):"
      #     ls -R "${GITHUB_WORKSPACE}"
      #     find "${GITHUB_WORKSPACE}" -name "*.jar"

      - name: Deploy Spring Boot App to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3 # SSH ì ‘ì†ì„ ìœ„í•œ GitHub Actionì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê³µìš© IP ë˜ëŠ” DNSë¥¼ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          username: ${{ secrets.EC2_USERNAME }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•  ì‚¬ìš©ìž ì´ë¦„(ì˜ˆ: ubuntu, ec2-user)ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          key: ${{ secrets.EC2_SSH_KEY }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í”„ë¼ì´ë¹— í‚¤ ë‚´ìš©ì„ GitHub Secretsì— ì €ìž¥í•˜ì„¸ìš”.
          port: 22 # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH í¬íŠ¸ìž…ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ 22ìž…ë‹ˆë‹¤.
          script: |
            # 1. ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ðŸ”¥ ê¸°ì¡´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤ (í¬íŠ¸ 8080)..."
            PID=$(sudo lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "   PID ${PID}ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              sudo kill -9 "$PID"
            else
              echo "   8080 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            fi

            # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ê¸°ì¡´ JAR íŒŒì¼ ì‚­ì œ
            DEPLOY_PATH="/home/ubuntu/app" # EC2 ë‚´ì˜ ë°°í¬ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ë³€ê²½í•˜ì„¸ìš”.
            echo "âž¡ï¸ ë°°í¬ ê²½ë¡œ ${DEPLOY_PATH}ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            if [ ! -d "${DEPLOY_PATH}" ]; then
              echo "   ë°°í¬ ë””ë ‰í† ë¦¬ ${DEPLOY_PATH}ê°€ ì¡´ìž¬í•˜ì§€ ì•Šì•„ ìƒì„±í•©ë‹ˆë‹¤."
              sudo mkdir -p "${DEPLOY_PATH}"
            fi
            cd "${DEPLOY_PATH}"

            echo "ðŸ—‘ï¸ï¸ ê¸°ì¡´ 'app.jar' íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤."
            rm -f app.jar

            # 3. ìƒˆë¡œìš´ JAR íŒŒì¼ ë³µì‚¬
            # 'download-artifact'ë¡œ ë‹¤ìš´ë¡œë“œëœ JAR íŒŒì¼ì€ í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬(.)ì— ìžˆìŠµë‹ˆë‹¤.
            SOURCE_JAR="./*.jar" # ë‹¤ìš´ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ì˜ ê²½ë¡œ
            
            JAR_FILE=$(ls -t ${SOURCE_JAR} 2>/dev/null | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ ë¹Œë“œëœ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${SOURCE_JAR}"
              exit 1 # JAR íŒŒì¼ì„ ì°¾ì§€ ëª»í•˜ë©´ ë°°í¬ ì‹¤íŒ¨
            fi

            echo "ðŸ“¥ ìƒˆë¡œìš´ JAR íŒŒì¼ '${JAR_FILE}'ì„ ${DEPLOY_PATH}ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤."
            cp "${JAR_FILE}" app.jar
            
            # 4. ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
            echo "ðŸš€ ìƒˆë¡œìš´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
            nohup java -jar app.jar > /dev/null 2>&1 < /dev/null &
            echo "âœ… ë°°í¬ ì™„ë£Œ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤."
